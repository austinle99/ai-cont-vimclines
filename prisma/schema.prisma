generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model KPI {
  id           Int    @id @default(autoincrement())
  utilization  String
  storageCost  String
  dwellTime    String
  approvalRate String
}

model Inventory {
  id    Int    @id @default(autoincrement())
  port  String
  type  String
  stock Int

  @@index([port, type])
}

model Booking {
  id          Int      @id @default(autoincrement())
  date        DateTime @default(now())
  origin      String
  destination String
  size        String
  qty         Int
  customer    String?
  status      String?
  // Optimization fields
  containerNo             String?
  emptyLaden              String?
  depot                   String?
  optimizationSuggestion  String?
  optimizationScore       Int?
  optimizationType        String?

  @@index([origin, destination, size])
  @@index([optimizationScore])
  @@index([optimizationType])
  @@index([date])
  @@index([emptyLaden])
  @@index([status])
}

model Proposal {
  id        String   @id
  route     String
  size      String
  qty       Int
  estCost   Float?
  benefit   Float?
  reason    String?
  status    String
  createdAt DateTime @default(now())

  @@index([status])
  @@index([createdAt])
}

model Alert {
  id          String    @id
  level       String
  message     String
  location    String?
  severity    String?
  description String?
  status      String    @default("active")
  createdAt   DateTime  @default(now())
  resolvedAt  DateTime?

  @@index([status])
  @@index([level])
  @@index([createdAt])
}

model Comment {
  id        Int      @id @default(autoincrement())
  content   String
  createdAt DateTime @default(now())
}

// ML Training and Learning Models
model MLTrainingData {
  id          String   @id @default(cuid())
  timestamp   DateTime @default(now())
  features    Json     // SuggestionFeatures as JSON
  suggestion  Json     // Full suggestion data
  outcome     Float?   // 0-1 score based on user action (null until feedback)
  context     Json     // Business context when suggestion was made
  sessionId   String?  // Group suggestions from same Excel upload
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  feedback SuggestionFeedback[]

  @@index([timestamp])
  @@index([sessionId])
}

model SuggestionFeedback {
  id           String   @id @default(cuid())
  suggestionId String   // References MLTrainingData.id
  action       String   // 'accepted', 'rejected', 'modified', 'ignored'
  userId       String?
  timestamp    DateTime @default(now())
  context      Json?    // Additional context about the feedback
  notes        String?  // User notes about why they took this action

  trainingData MLTrainingData @relation(fields: [suggestionId], references: [id], onDelete: Cascade)

  @@index([suggestionId])
  @@index([action])
}

// iShip Integration and Longstay Analysis Models
model ContainerTracking {
  id                String   @id @default(cuid())
  containerNo       String   @unique
  containerType     String   // 20GP, 40GP, 40HC, etc.
  emptyLaden        String   // 'empty' or 'laden'
  currentLocation   String   // Depot/Port name
  lastMovementDate  DateTime
  firstSeenDate     DateTime @default(now())
  dwellDays         Int      @default(0)

  // iShip specific data
  shipmentId        String?
  billOfLading      String?
  customerId        String?
  customerName      String?
  consignee         String?

  // Movement history
  movementHistory   Json?    // Array of movement records

  // Status tracking
  status            String   @default("active") // active, relocated, picked-up, longstay
  lastUpdated       DateTime @updatedAt
  createdAt         DateTime @default(now())

  // Relations
  longstayAnalyses  LongstayAnalysis[]
  ishipData         IShipData[]

  @@index([containerNo])
  @@index([emptyLaden])
  @@index([currentLocation])
  @@index([status])
  @@index([dwellDays])
  @@index([lastMovementDate])
}

model LongstayAnalysis {
  id                    String   @id @default(cuid())
  containerTrackingId   String
  containerNo           String

  // Analysis data
  currentDwellDays      Int
  predictedDwellDays    Int?     // ML prediction
  longstayRiskScore     Float    // 0-100, probability of becoming longstay
  riskLevel             String   // low, medium, high, critical

  // Prediction factors
  historicalPattern     Json?    // Historical dwell time patterns
  seasonalFactors       Json?    // Seasonal influences
  locationFactors       Json?    // Location-specific factors
  demandFactors         Json?    // Demand/supply factors

  // Recommendations
  recommendedAction     String?  // relocate, monitor, urgent-pickup, etc.
  suggestedDestination  String?
  estimatedCost         Float?
  potentialSavings      Float?

  // Thresholds
  longstayThreshold     Int      @default(14) // Days to be considered longstay
  criticalThreshold     Int      @default(21) // Days to be critical

  // Tracking
  analysisDate          DateTime @default(now())
  lastUpdated           DateTime @updatedAt
  status                String   @default("active") // active, resolved, escalated

  // Relations
  containerTracking     ContainerTracking @relation(fields: [containerTrackingId], references: [id], onDelete: Cascade)

  @@index([containerNo])
  @@index([longstayRiskScore])
  @@index([riskLevel])
  @@index([currentDwellDays])
  @@index([analysisDate])
  @@index([status])
}

model IShipData {
  id                  String   @id @default(cuid())
  containerTrackingId String?

  // Raw iShip data fields
  containerNo         String
  shipmentNo          String?
  bookingNo           String?
  billOfLading        String?

  // Container details
  containerType       String?
  emptyLaden          String?
  depot               String?

  // Shipment info
  origin              String?
  destination         String?
  shipper             String?
  consignee           String?
  commodity           String?

  // Dates
  gateInDate          DateTime?
  gateOutDate         DateTime?
  estimatedPickupDate DateTime?
  actualPickupDate    DateTime?

  // Status
  currentStatus       String?
  remarks             String?

  // Scraping metadata
  scrapedAt           DateTime @default(now())
  sourceUrl           String?
  dataHash            String?  // To detect duplicates

  // Relations
  containerTracking   ContainerTracking? @relation(fields: [containerTrackingId], references: [id])

  @@index([containerNo])
  @@index([scrapedAt])
  @@index([depot])
  @@index([currentStatus])
  @@index([dataHash])
}

// Longstay ML Training Data
model LongstayMLData {
  id                String   @id @default(cuid())
  containerNo       String

  // Features for ML training
  features          Json     // All engineered features
  actualDwellDays   Int      // Actual outcome
  predictedDwellDays Int?    // Model prediction
  error             Float?   // Prediction error

  // Context
  containerType     String
  location          String
  seasonMonth       Int
  weekOfYear        Int

  // Model performance
  modelVersion      String   @default("v1")
  accuracy          Float?

  createdAt         DateTime @default(now())

  @@index([containerNo])
  @@index([location])
  @@index([createdAt])
  @@index([modelVersion])
}
